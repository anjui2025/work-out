<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è¨“ç·´ç´€éŒ„</title>
  <style>
    :root{
      --bg0:#06080f;
      --bg1:#0b0f19;
      --card:#0f1421cc;
      --ink:#eaf0ff;
      --muted:#9fb0d0;
      --border:#1c2440;
      --brand:#7aa2ff;
      --brand-2:#b794f4;
      --brand-3:#39d98a;
      --radius:16px;
      --shadow:0 8px 32px rgba(0,0,0,.45);
      --fs-h1:clamp(18px,5vw,22px);
      --fs-base:15px;
      --fs-label:13px;
      --gap:14px;
    }

    body.light {
      --bg0: #f4f6fa;
      --bg1: #ffffff;
      --card: #ffffff;
      --ink: #1a1a1a;
      --muted: #67748a;
      --border: #dce1eb;
      --brand: #9fbfe2;
      --brand-2: #e2e1a0;
      --brand-3: #2e9acc;
      --shadow: 0 6px 20px rgba(0, 0, 0, 0.06);
    }
    @media(min-width:640px){:root{--fs-base:16px;--gap:16px}}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Noto Sans TC",Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--ink);background:var(--bg0);}
    .wrap{max-width:840px;margin:24px auto 56px;padding:0 16px;}
    .card{position:relative;border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);background:var(--card);backdrop-filter:blur(12px) saturate(120%);border:1px solid var(--border);}
    header{padding:16px;border-bottom:1px solid var(--border);display:flex;gap:12px;align-items:center;justify-content:space-between}
    h1{font-size:var(--fs-h1);margin:0;letter-spacing:.2px;color:var(--brand)}
    .hint{color:var(--muted);font-size:12px}
    .btn{appearance:none;border:1px solid transparent;border-radius:12px;cursor:pointer;font-weight:700;padding:10px 14px;transition:transform .12s ease,box-shadow .2s ease}
    .btn:active{transform:translateY(1px)}
    .btn-primary{background:linear-gradient(90deg,var(--brand),var(--brand-2));color:#0b0d12;box-shadow:0 0 16px #7aa2ff44}
    .btn-outline{background:transparent;color:var(--ink);border:1px solid #2a3560}
    .btn-outline:hover{background:#151b31}
    form{padding:16px;display:grid;gap:var(--gap)}
    label{font-size:var(--fs-label);color:var(--muted);margin-bottom:6px;display:block}
    input,textarea{
      width:100%;
      background:var(--bg1);
      color:var(--ink);
      border:1px solid var(--border);
      border-radius:12px;
      padding:14px;
      font-size:var(--fs-base);
      outline:none;
      transition:background 0.2s ease, color 0.2s ease;
    }
    textarea{min-height:120px;resize:vertical}
    input:focus,textarea:focus{border-color:var(--brand);box-shadow:0 0 0 3px #7aa2ff44}
    .row{display:grid;grid-template-columns:1fr;gap:var(--gap)}
    @media(min-width:480px){.row{grid-template-columns:1fr 1fr}}
    .actions{display:flex;gap:10px;align-items:center;justify-content:flex-end;padding:0 16px 16px}
    .msg{padding:12px 16px;border-top:1px solid var(--border);font-size:14px;display:none}
    .msg.ok{color:#b6f3c9}.msg.err{color:#ffb3b3}
    .panel{display:none}.panel.show{display:block}
    .settings{padding:16px;background:var(--bg1)}
    .help{font-size:12px;color:var(--muted);line-height:1.5}
    .mono{font-family:ui-monospace,Menlo,Monaco,Consolas,monospace;font-size:12px;color:#c9d4f5}
    .table{width:100%;border-collapse:collapse;margin-top:8px;font-size:12px}
    .table th,.table td{border:1px solid var(--border);padding:6px 8px;text-align:left}

    /* === æ–°å¢ï¼šæˆå°æ•¸å­—è¼¸å…¥çš„ç‰ˆå‹ === */
    .pair{display:grid;grid-template-columns:1fr auto 1fr;gap:8px;align-items:center}
    .pair .x{color:#8aa2e8;opacity:.8}
    .minihelp{font-size:12px;color:var(--muted);margin-top:6px}
    .set-title{font-size:12px;color:#cbd6ff;margin-bottom:6px;letter-spacing:.5px}
    input[type="number"]{appearance:textfield}
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button{appearance:none;margin:0}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <header>
      <div>
        <h1>è¨“ç·´ç´€éŒ„</h1>
        <div class="hint" id="subhint">ç´€éŒ„æœƒåœ¨excelè¡¨ä¸­å”·~</div>
      </div>
      <div style="display:flex; gap:8px">
        <button id="btnToLog" class="btn btn-outline" style="display:none">è¿”å›ç´€éŒ„</button>
        <button id="btnToSettings" class="btn btn-outline">è¨­å®š</button>
      </div>
    </header>

    <section id="settingsPanel" class="panel settings">
      <label for="prefillUrl">è²¼ä¸Šä½ çš„ <b>é å…ˆå¡«ç­”é€£çµ</b></label>
      <input id="prefillUrl" placeholder="https://docs.google.com/forms/d/e/.../viewform?..." />
      <div class="actions" style="padding:12px 0 0; display: flex; gap: 10px;">
        <button id="oneClickSetup" class="btn btn-primary">è§£æä¸¦å„²å­˜</button>
        <button onclick="toggleTheme()" class="btn btn-outline">ğŸŒ— åˆ‡æ›ä¸»é¡Œ</button>
      </div>
      <div id="parseResult" style="display:none; margin-top:10px">
        <table class="table"><thead><tr><th>æ•¸å­—</th><th>åµæ¸¬åˆ°çš„ entry ä»£ç¢¼</th><th>å°æ‡‰æ¬„ä½</th></tr></thead><tbody id="tblBody"></tbody></table>
        <div class="help" style="margin-top:6px">å°æ‡‰è¦å‰‡ï¼š<span class="mono">1â†’itemã€2â†’w1ã€3â†’w2ã€4â†’w3ã€5â†’w4ã€6â†’note</span>ã€‚</div>
      </div>
      <details style="margin-top:12px"><summary class="help">é€²éšè¨­å®šï¼ˆé€šå¸¸ä¸éœ€ä¿®æ”¹ï¼‰</summary>
        <div style="display:grid; gap:8px; margin-top:8px">
          <label>formResponseï¼š<input id="formUrl" class="mono" /></label>
          <label>itemï¼š<input id="entryItem" class="mono" /></label>
          <label>w1ï¼š<input id="entryW1" class="mono" /></label>
          <label>w2ï¼š<input id="entryW2" class="mono" /></label>
          <label>w3ï¼š<input id="entryW3" class="mono" /></label>
          <label>w4ï¼š<input id="entryW4" class="mono" /></label>
          <label>noteï¼š<input id="entryNote" class="mono" /></label>
          <div class="actions" style="padding:0"><button id="saveSettings" class="btn btn-outline">æ‰‹å‹•å„²å­˜</button></div>
        </div>
      </details>
    </section>

    <section id="logPanel" class="panel show">
      <form id="logForm" autocomplete="off">
        <div>
          <label for="item">itemï¼ˆå‹•ä½œï¼‰</label>
          <input id="item" name="item" autocomplete="off" placeholder="ä¾‹ï¼šæ»‘è¼ªä¸‹æ‹‰" />
        </div>

        <!-- === ä¿®æ”¹ï¼šæ¯çµ„æ”¹æˆ é‡é‡ Ã— æ¬¡æ•¸ å…©å€‹æ•¸å­—æ¡† + éš±è—åˆä½µå€¼ === -->
        <div class="row">
          <div>
            <div class="set-title">Set 1</div>
            <div class="pair">
              <input id="w1w" inputmode="decimal" type="number" step="any" placeholder="é‡é‡ (kg)">
              <span class="x">Ã—</span>
              <input id="w1r" inputmode="numeric" type="number" step="1" placeholder="æ¬¡æ•¸ (reps)">
            </div>
            <input id="w1" type="hidden">
            <div class="minihelp">å¡«å¥½ Set 1 å¾Œï¼ŒSet 2ã€3 æœƒè‡ªå‹•å¸¶å…¥ç›¸åŒæ•¸å­—ï¼Œå¯å†è‡ªè¡Œä¿®æ”¹ã€‚</div>
          </div>

          <div>
            <div class="set-title">Set 2</div>
            <div class="pair">
              <input id="w2w" inputmode="decimal" type="number" step="any" placeholder="é‡é‡ (kg)">
              <span class="x">Ã—</span>
              <input id="w2r" inputmode="numeric" type="number" step="1" placeholder="æ¬¡æ•¸ (reps)">
            </div>
            <input id="w2" type="hidden">
          </div>
        </div>

        <div class="row">
          <div>
            <div class="set-title">Set 3</div>
            <div class="pair">
              <input id="w3w" inputmode="decimal" type="number" step="any" placeholder="é‡é‡ (kg)">
              <span class="x">Ã—</span>
              <input id="w3r" inputmode="numeric" type="number" step="1" placeholder="æ¬¡æ•¸ (reps)">
            </div>
            <input id="w3" type="hidden">
          </div>

          <div>
            <div class="set-title">Set 4ï¼ˆå¯ç•™ç©ºï¼‰</div>
            <div class="pair">
              <input id="w4w" inputmode="decimal" type="number" step="any" placeholder="é‡é‡ (kg)">
              <span class="x">Ã—</span>
              <input id="w4r" inputmode="numeric" type="number" step="1" placeholder="æ¬¡æ•¸ (reps)">
            </div>
            <input id="w4" type="hidden">
          </div>
        </div>

        <div>
          <label for="note">How feeling / note / recordï¼ˆå¯ç•™ç©ºï¼‰</label>
          <textarea id="note" name="note" autocomplete="off" placeholder="ä¾‹ï¼šæœ€å¾Œä¸€çµ„æœ€å¾ŒåŠ›ç«­äº†ï¼æˆ–æ˜¯å‚™è¨»ä½ çš„è¨“ç·´æ—¥æœŸ"></textarea>
        </div>

        <div class="actions">
          <button type="button" id="fillTemplate" class="btn btn-outline">å¿«é€Ÿå¡«å…¥ç¯„ä¾‹</button>
          <button type="submit" class="btn btn-primary">é€å‡ºåˆ° Google è¡¨å–®</button>
        </div>
      </form>
      <div id="msg" class="msg"></div>
    </section>
  </div>
</div>

<script>
  // ğŸŒ— ä¸»é¡Œåˆ‡æ›å„²å­˜æ©Ÿåˆ¶
  const themeKey = 'training-logger-theme';
  function applyTheme(t) {
    if (t === 'light') document.body.classList.add('light');
    else document.body.classList.remove('light');
  }
  function toggleTheme() {
    const current = document.body.classList.contains('light') ? 'dark' : 'light';
    localStorage.setItem(themeKey, current);
    applyTheme(current);
  }
  applyTheme(localStorage.getItem(themeKey) || 'dark');

  const $=s=>document.querySelector(s);
  const storeKey='training-logger-settings-v6';
  const loadSettings=()=>{try{return JSON.parse(localStorage.getItem(storeKey))||{}}catch{return{}}};
  const saveSettings=obj=>localStorage.setItem(storeKey,JSON.stringify(obj||{}));
  function applySettingsToUI(s){$('#formUrl').value=s.formUrl||'';$('#entryItem').value=s.entryItem||'';$('#entryW1').value=s.entryW1||'';$('#entryW2').value=s.entryW2||'';$('#entryW3').value=s.entryW3||'';$('#entryW4').value=s.entryW4||'';$('#entryNote').value=s.entryNote||'';}
  function toSettings(){$('#settingsPanel').classList.add('show');$('#logPanel').classList.remove('show');$('#btnToSettings').style.display='none';$('#btnToLog').style.display='inline-block';$('#msg').style.display='none';}
  function toLog(){$('#settingsPanel').classList.remove('show');$('#logPanel').classList.add('show');$('#btnToSettings').style.display='inline-block';$('#btnToLog').style.display='none';$('#msg').style.display='none';}
  $('#btnToSettings').addEventListener('click',toSettings);$('#btnToLog').addEventListener('click',toLog);(function(){applySettingsToUI(loadSettings());toLog();})();

  function showMsg(t,ok){const el=$('#msg');el.textContent=t;el.className='msg '+(ok?'ok':'err');el.style.display='block';setTimeout(()=>{el.style.display='none';},3500)}
  function cleanFormUrl(u){try{const x=new URL(u);x.search='';x.pathname=x.pathname.replace('/viewform','/formResponse');return x.toString()}catch{return u}}

  function parsePrefill(url){
    const p=new URL(url),q=p.searchParams,e={};
    q.forEach((v,k)=>{if(k.startsWith('entry.'))e[k]=v});
    const w={'1':'entryItem','2':'entryW1','3':'entryW2','4':'entryW3','5':'entryW4','6':'entryNote','item':'entryItem','w1':'entryW1','w2':'entryW2','w3':'entryW3','w4':'entryW4','note':'entryNote'},m={};
    Object.keys(e).forEach(k=>{const v=String(e[k]).trim().toLowerCase();if(w[v])m[w[v]]=k});
    const d={entryItem:m.entryItem||'',entryW1:m.entryW1||'',entryW2:m.entryW2||'',entryW3:m.entryW3||'',entryW4:m.entryW4||'',entryNote:m.entryNote||''};
    p.search='';p.pathname=p.pathname.replace('/viewform','/formResponse');
    return{detected:d,formUrl:p.toString()}
  }

  $('#oneClickSetup').addEventListener('click',()=>{
    const u=($('#prefillUrl').value||'').trim();
    if(!u){alert('è«‹è²¼ä¸Šé å¡«é€£çµ');return}
    let r;try{r=parsePrefill(u)}catch{alert('é€£çµæ ¼å¼ä¸æ­£ç¢º');return}
    const {detected,formUrl}=r,s=Object.assign({},loadSettings(),detected,{formUrl:cleanFormUrl(formUrl)});
    saveSettings(s);applySettingsToUI(s);
    const o=['item','w1','w2','w3','w4','note'],c=[detected.entryItem,detected.entryW1,detected.entryW2,detected.entryW3,detected.entryW4,detected.entryNote],
      rows=o.map((f,i)=>`<tr><td>${i+1}</td><td class="mono">${c[i]||'-'}</td><td>${f}</td></tr>`).join('');
    $('#tblBody').innerHTML=rows;$('#parseResult').style.display='block';
    toLog();showMsg('âœ… è¨­å®šå·²å„²å­˜ï¼å¯ä»¥é–‹å§‹ä½¿ç”¨äº†ã€‚',true)
  });

  $('#saveSettings').addEventListener('click',()=>{
    const s={
      formUrl:cleanFormUrl($('#formUrl').value.trim()),
      entryItem:$('#entryItem').value.trim(),
      entryW1:$('#entryW1').value.trim(),
      entryW2:$('#entryW2').value.trim(),
      entryW3:$('#entryW3').value.trim(),
      entryW4:$('#entryW4').value.trim(),
      entryNote:$('#entryNote').value.trim()
    };
    saveSettings(s);applySettingsToUI(s);alert('å·²æ‰‹å‹•å„²å­˜è¨­å®š')
  });


  function parseCombinedInput(prefix) {
  const weightInput = $(`#${prefix}w`);
  const repsInput = $(`#${prefix}r`);

  const raw = weightInput.value.trim();
  const match = normalizeWxR(raw).match(/^(\d+(?:\.\d+)?)\*(\d+)$/);
  if (match) {
    weightInput.value = match[1];
    repsInput.value = match[2];
  }
}

  // === æ–°å¢ï¼šæŠŠ æˆå°æ•¸å­— è½‰æˆã€Œé‡é‡*æ¬¡æ•¸ã€å¯«é€²éš±è—æ¬„ä½ï¼ˆw1~w4ï¼‰ ===
  function combinePair(prefix){
    const w=$(`#${prefix}w`)?.value?.trim();
    const r=$(`#${prefix}r`)?.value?.trim();
    const combo=(w!=='' && r!=='') ? `${w}*${r}` : '';
    $(`#${prefix}`).value=combo;
  }

  // === æ–°å¢ï¼šç¬¬ä¸€çµ„å¡«å®Œå¾Œï¼Œè‡ªå‹•å¸¶å…¥åˆ°ç¬¬ 2ã€3 çµ„ï¼ˆç©ºçš„æ™‚å€™æ‰è¦†å¯«ï¼‰ ===
  function maybePropagateFromSet1(){
    const w1 = $('#w1w').value?.trim();
    const r1 = $('#w1r').value?.trim();

    // ç¢ºä¿å…©å€‹éƒ½æœ‰å€¼æ‰è¤‡è£½
    if(w1 !== '' && r1 !== ''){
      if($('#w2w').value.trim() === '') $('#w2w').value = w1;
      if($('#w2r').value.trim() === '') $('#w2r').value = r1;
      if($('#w3w').value.trim() === '') $('#w3w').value = w1;
      if($('#w3r').value.trim() === '') $('#w3r').value = r1;
      combinePair('w2');
      combinePair('w3');
    }
  }

  // ç¶å®šæ‰€æœ‰æˆå°è¼¸å…¥çš„åŒæ­¥
  ['w1','w2','w3','w4'].forEach(p=>{
    $(`#${p}w`).addEventListener('input',()=>{
      parseCombinedInput(p);
      combinePair(p);
    });
    $(`#${p}r`).addEventListener('input',()=>{
      combinePair(p);
    });
  });

  // âœ… æ”¹æˆã€Œåªæœ‰é›¢é–‹ w1 æ¬„ä½ï¼ˆblurï¼‰æ™‚æ‰ propagateã€
  $('#w1w').addEventListener('blur', maybePropagateFromSet1);
  $('#w1r').addEventListener('blur', maybePropagateFromSet1);

  function normalizeWxR(s){ if(!s)return''; return s.replace(/x|X|Ã—/g,'*').split(' ').join('').trim() }

  // é€å‡ºæ™‚æ²¿ç”¨åŸæœ¬æµç¨‹ï¼ˆè®€éš±è—çš„ w1~w4 åˆä½µå€¼ï¼‰
  $('#logForm').addEventListener('submit',async e=>{
    e.preventDefault();
    const s=loadSettings();
    if(!s.formUrl){toSettings();alert('è«‹å…ˆå®Œæˆä¸€éµè¨­å®š');return}

    // å…ˆç¢ºä¿éš±è—æ¬„ä½æœ€æ–°
    ['w1','w2','w3','w4'].forEach(p=>combinePair(p));

    const item=($('#item').value||'').trim(),
          w1=$('#w1').value, w2=$('#w2').value, w3=$('#w3').value, w4=$('#w4').value,
          note=($('#note').value||'').trim();

    const p=new URLSearchParams();
    if(s.entryItem&&item!=='')p.append(s.entryItem,item);
    if(s.entryW1&&w1!=='')p.append(s.entryW1,w1);
    if(s.entryW2&&w2!=='')p.append(s.entryW2,w2);
    if(s.entryW3&&w3!=='')p.append(s.entryW3,w3);
    if(s.entryW4&&w4!=='')p.append(s.entryW4,w4);
    if(s.entryNote&&note!=='')p.append(s.entryNote,note);

    const postUrl=cleanFormUrl(s.formUrl);
    console.log('[POST]',postUrl,p.toString());
    try{
      await fetch(postUrl,{method:'POST',mode:'no-cors',headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},body:p.toString()});
      showMsg('âœ… å·²é€å‡ºï¼ˆè«‹åˆ°è¡¨å–®å›æ‡‰/è©¦ç®—è¡¨æŸ¥çœ‹ï¼‰',true);

      // æ¸…ç©ºé¡¯ç¤ºç”¨æ¬„ä½èˆ‡éš±è—æ¬„ä½
      $('#item').value='';
      ['w1','w2','w3','w4'].forEach(pref=>{
        $(`#${pref}w`).value=''; $(`#${pref}r`).value=''; $(`#${pref}`).value='';
      });
      $('#note').value='';
    }catch(err){
      console.error(err);
      showMsg('é€å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥è¨­å®šæˆ–ç¨å¾Œå†è©¦ã€‚',false)
    }
  });

  // ä¿ç•™åŸæœ¬ query åƒæ•¸å°å…¥è¨­å®š
  (function(){
    const q=new URLSearchParams(location.search);
    if(!q.toString())return;
    const s=loadSettings(),u={
      formUrl:cleanFormUrl(q.get('form')||s.formUrl),
      entryItem:q.get('i')||s.entryItem,
      entryW1:q.get('w1')||s.entryW1,
      entryW2:q.get('w2')||s.entryW2,
      entryW3:q.get('w3')||s.entryW3,
      entryW4:q.get('w4')||s.entryW4,
      entryNote:q.get('n')||s.entryNote
    };
    saveSettings(u);applySettingsToUI(u)
  })();

  // ç¯„ä¾‹æŒ‰éˆ•ï¼šä¹Ÿæ”¹æˆæˆå°å¡«å¯«
  $('#fillTemplate')?.addEventListener('click',()=>{
    $('#item').value='æ»‘è¼ªä¸‹æ‹‰';
    $('#w1w').value='25'; $('#w1r').value='10'; combinePair('w1');
    $('#w2w').value='25'; $('#w2r').value='10'; combinePair('w2');
    $('#w3w').value='20'; $('#w3r').value='12'; combinePair('w3');
    $('#w4w').value='';  $('#w4r').value='';  combinePair('w4');
    $('#note').value='æœ€å¾Œä¸€çµ„æœ‰é»æŠ–ï¼Œä½†ç©©ï¼';
  });
</script>
</body>
</html>
